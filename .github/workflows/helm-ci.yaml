name: Helm Charts CI/CD

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  lint:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.13.0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: List charts
        run: |
          ls -al
          ls -al homeassistant || true
          ls -al network-ups-tools || true
          ls -al zigbee2mqtt || true

      - name: Run chart-testing (lint)
        run: |
          ct lint --charts homeassistant,network-ups-tools,zigbee2mqtt --chart-dirs . --debug

  build-and-push:
    name: Build and Push Helm Charts
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.13.0

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io \
            --username ${{ github.actor }} \
            --password-stdin

      - name: Create dist directory
        run: mkdir -p dist

      - name: Package Helm Charts
        run: |
          helm package -u -d dist/ homeassistant
          helm package -u -d dist/ zigbee2mqtt
          helm package -u -d dist/ network-ups-tools

      - name: List packaged charts
        run: ls -al dist/

      - name: Push charts to GitHub Container Registry
        run: |
          # Convertir le nom du repo en minuscules pour GHCR
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          # Push homeassistant
          CHART_FILE=$(ls dist/homeassistant-*.tgz | head -n 1)
          helm push "$CHART_FILE" oci://ghcr.io/${REPO_OWNER}/charts
          
          # Push zigbee2mqtt
          CHART_FILE=$(ls dist/zigbee2mqtt-*.tgz | head -n 1)
          helm push "$CHART_FILE" oci://ghcr.io/${REPO_OWNER}/charts
          
          # Push network-ups-tools
          CHART_FILE=$(ls dist/network-ups-tools-*.tgz | head -n 1)
          helm push "$CHART_FILE" oci://ghcr.io/${REPO_OWNER}/charts

      - name: Logout from registries
        if: always()
        run: |
          helm registry logout ghcr.io || true

